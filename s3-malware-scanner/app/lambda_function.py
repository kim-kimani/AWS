import boto3
import json
import subprocess

s3 = boto3.client('s3')

def lambda_handler(event, context):
    bucket = event['Records'][0]['s3']['bucket']['name']
    key = event['Records'][0]['s3']['object']['key']

    download_path = f"/tmp/{key}"
    s3.download_file(bucket, key, download_path)

    update_virus_definitions()

    result = scan_file(download_path)

    if "Infected files: 0" in result:
        s3.delete_object(download_path, 'clean-bucket', key)
    else:
        s3.delete_object(download_path, 'quarantine-bucket', key)

def update_virus_definitions():
    subprocess.run(["freshclam"], check=True)

def scan_file(file_path):
    result = subprocess.run(["clamscan", file_path], stdout=subprocess.PIPE)
    return result.stdout.decode()